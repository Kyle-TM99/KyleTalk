<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}">
<head>
	 <link th:href="@{/css/chat.css}" rel="stylesheet">
    <!-- FullCalendar 최신 버전 -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <!-- FullCalendar 한글 지원 -->
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/ko.global.min.js'></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <title>채팅방</title>
</head>
<th:block layout:fragment="content">
    <div th:if="${session.member}" 
         th:data-member-id="${session.member.memberId}"
         th:data-member-nickname="${session.member.nickname}"
         th:data-member-social-type="${session.member.socialType}"
         th:data-member-profile-image="${session.member.memberImage}"
         style="display: none;">
    </div>

    <div class="chat-wrapper">
        <div class="split-container">
            <!-- 왼쪽: 채팅 영역 -->
            <div class="chat-section">
                <!-- 채팅방 헤더 --> 
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h5 class="mb-0" th:text="${room.roomName}">채팅방</h5>
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-people"></i>
                                    참여자 (<span id="participantCount">0</span>)
                                </button>
                                <div class="dropdown-menu participants-dropdown" id="participantsList">
                                    <!-- 참여자 목록이 동적으로 추가됨 -->
                                </div>
                            </div>
                            <!-- 방장/일반 참여자에 따른 버튼 -->
                            <th:block th:if="${#strings.equals(session.member.memberId, room.roomAdmin)}">
                                <button class="btn btn-danger" onclick="deleteRoom()">
                                    <i class="bi bi-trash"></i> 방 삭제
                                </button>
                                <button class="btn btn-primary ms-2" onclick="showTransferAdminModal()">
                                    <i class="bi bi-person-fill-gear"></i> 방장 위임
                                </button>
                            </th:block>
                            <th:block th:unless="${#strings.equals(session.member.memberId, room.roomAdmin)}">
                                <button class="btn btn-warning" onclick="leaveRoom()">
                                    <i class="bi bi-box-arrow-right"></i> 나가기
                                </button>
                            </th:block>
                        </div>
                    </div>
                </div>

                <!-- 채팅 메시지 영역 -->
                <div class="chat-messages" id="messageArea">
                    <!-- 초기 메시지 로드 -->
                    <th:block th:each="message : ${messages}">
                        <div th:class="${message.sender == session.member.memberId ? 'message sent' : 'message received'}">
                            <strong th:text="${message.nickname}"></strong>
                            <p th:text="${message.message}"></p>
                            <small th:text="${#temporals.format(message.sentAt.toLocalDateTime(), 'yyyy-MM-dd HH:mm')}"></small>
                        </div>
                    </th:block>
                </div>

                <!-- 입력 영역 -->
                <div class="chat-input-area">
                    <form id="messageForm">
                        <div class="input-group align-items-center">
                            <input type="text" id="message" class="form-control" 
                                   placeholder="메시지를 입력하세요..." autocomplete="off">
                            <button type="submit" class="send-btn">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 오른쪽: 게시판/캘린더 탭 영역 -->
            <div class="side-section">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#boardTab" type="button">게시판</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#calendarTab" type="button">일정</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    
                    <!-- 게시판 탭 -->
                    <div class="tab-pane fade show active" id="boardTab">
                        <div class="board-container">
                            <div class="board-header d-flex justify-content-between align-items-center p-3">
                                <h5 class="mb-0">게시판</h5>
                                <button class="btn btn-primary" onclick="openBoardModal()">
                                    <i class="bi bi-plus-lg"></i> 글쓰기
                                </button>
                            </div>
                            <div class="board-list p-3">
                                <div class="table-responsive">
                                    <table class="table">
                                        <tbody id="boardList">
                                            <!-- 게시글 목록이 여기에 동적으로 추가됨 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 캘린더 탭 -->
                    <div class="tab-pane fade" id="calendarTab">
                        <div class="calendar-container">
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 방장 위임 모달 -->
        <div class="modal fade" id="transferAdminModal" tabindex="-1" aria-labelledby="transferAdminModalLabel">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="transferAdminModalLabel">방장 위임</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="participantsForTransfer">
                            <!-- 참여자 목록이 동적으로 추가됨 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 일정 추가 모달 -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">일정 추가</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="eventForm">
                            <div class="mb-3">
                                <label class="form-label">제목</label>
                                <input type="text" class="form-control" id="eventTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">시작 일시</label>
                                <input type="datetime-local" class="form-control" id="eventStartDate" required
                                       onchange="updateEndDateMin()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">종료 일시</label>
                                <input type="datetime-local" class="form-control" id="eventEndDate" required
                                       min="">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">설명</label>
                                <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" onclick="submitEvent()">저장</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 게시글 작성 모달 -->
        <div class="modal fade" id="writeBoardModal" tabindex="-1" aria-labelledby="writeBoardModalLabel">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="writeBoardModalLabel">게시글 작성</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="writeBoardForm">
                            <div class="mb-3">
                                <label for="boardTitle" class="form-label">제목</label>
                                <input type="text" class="form-control" id="boardTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="boardContent" class="form-label">내용</label>
                                <textarea class="form-control" id="boardContent" rows="5" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" onclick="submitBoard()">등록</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 일정 상세 정보 모달 추가 -->
        <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventDetailModalLabel">일정 상세</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="fw-bold">제목</label>
                            <p id="detailEventTitle" class="mb-3"></p>
                            <label class="fw-bold">시작 일시</label>
                            <p id="detailEventStart" class="mb-3"></p>
                            <label class="fw-bold">종료 일시</label>
                            <p id="detailEventEnd" class="mb-3"></p>
                            <label class="fw-bold">설명</label>
                            <p id="detailEventDescription" class="mb-3"></p>
                            <label class="fw-bold">작성자</label>
                            <p id="detailEventCreator" class="mb-3"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-danger" id="deleteEventBtn" style="display: none;">삭제</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 채팅방 정보를 hidden input으로 저장 -->
        <input type="hidden" id="roomId" th:value="${room.roomId}">
    </div>
</th:block>

<th:block layout:fragment="script">
    <!-- 필수 라이브러리 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 소켓 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script th:inline="javascript">
        // 현재 사용자 정보 초기화
        const currentUser = {
            memberId: [[${session.member.memberId}]],
            nickname: [[${session.member.nickname}]],
            socialType: [[${session.member.socialType}]],
            memberImage: [[${session.member.memberImage}]]
        };
        
        // 채팅방 정보 초기화
        const room = {
            roomId: [[${room.roomId}]],
            roomName: [[${room.roomName}]],
            roomAdmin: [[${room.roomAdmin}]]
        };
        
        // 채팅방 ID 초기화
        const roomId = room.roomId;

        // 게시글 목록 로드 함수 추가
        function loadBoardList() {
            $.ajax({
                url: `/api/chat/board/${roomId}`,
                type: 'GET',
                success: function(boards) {
                    const boardList = $('#boardList');
                    boardList.empty();
                    
                    boards.forEach(board => {
                        const date = new Date(board.joinedAt).toLocaleDateString();
                        const isWriter = board.memberId === currentUser.memberId;
                        boardList.append(`
                            <tr class="board-row">
                                <td colspan="3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="board-title" style="cursor: pointer;">
                                            ${board.boardTitle}
                                        </div>
                                        ${isWriter ? `
                                            <button class="btn btn-link text-danger p-0 delete-board" 
                                                    data-board-id="${board.boardId}" 
                                                    style="font-size: 1.2rem;">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <div class="d-flex align-items-center">
                                            <img src="${board.writerImage}" class="rounded-circle me-2" width="24" height="24">
                                            <span>${board.writerNickname}</span>
                                        </div>
                                        <span class="text-muted">${date}</span>
                                    </div>
                                    <div class="board-content" style="display: none; padding: 10px; background-color: #f8f9fa; margin-top: 10px;">
                                        ${board.boardContent}
                                    </div>
                                </td>
                            </tr>
                        `);
                    });

                    // 제목 클릭 이벤트 추가
                    $('.board-title').click(function() {
                        const content = $(this).closest('td').find('.board-content');
                        content.slideToggle(200);
                    });

                    // 삭제 버튼 클릭 이벤트 추가
                    $('.delete-board').click(function(e) {
                        e.stopPropagation(); // 이벤트 버블링 방지
                        const boardId = $(this).data('board-id');
                        console.log('삭제할 게시글 ID:', boardId);  // boardId 값 확인
                        if (confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                            deleteBoard(boardId);
                        }
                    });
                },
                error: function(error) {
                    console.error('게시글 목록 로드 실패:', error);
                }
            });
        }

        // 게시글 삭제 함수
        function deleteBoard(boardId) {
            if (!boardId) {
                console.error('게시글 ID가 없습니다.');
                return;
            }
            $.ajax({
                url: `/api/chat/board/${boardId}`,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        loadBoardList(); // 목록 새로고침
                    } else {
                        alert(response.error || '게시글 삭제에 실패했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    alert('게시글 삭제 중 오류가 발생했습니다.');
                    console.error('게시글 삭제 오류:', error);
                    console.error('응답 데이터:', xhr.responseText);  // 서버 응답 확인
                }
            });
        }

        // DOM이 로드된 후 이벤트 핸들러 등록
        $(document).ready(function() {
            // 소켓 연결
            connect();
            
            // 메시지 전송 폼 이벤트 핸들러 등록
            $('#messageForm').on('submit', function(e) {
                sendMessage(e);
            });
            
            // 초기 참여자 목록 로드
            loadParticipants();
            
            // 초기 게시글 목록 로드
            loadBoardList();
        });

        // 소켓 관련 변수
        let stompClient = null;
        
        // 방장 여부 확인을 위한 디버깅
        console.log('Current User ID:', currentUser.memberId);
        console.log('Room Admin ID:', room.roomAdmin);
        console.log('Is Admin?:', currentUser.memberId === room.roomAdmin);
        
        // 소켓 연결 함수
        function connect() {
            // 소켓 연결
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            // 소켓 연결 성공 시 처리
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                
                // 채팅 메시지 구독
                stompClient.subscribe('/topic/chat/' + roomId, function(message) {
                    console.log('Received message:', message);
                    showMessage(JSON.parse(message.body));
                });
                
                // 참여자 목록 구독
                stompClient.subscribe('/topic/chat/' + roomId + '/participants', function(message) {
                    console.log('Received participants:', message);
                    updateParticipantsList(JSON.parse(message.body));
                });
                
                sendJoinMessage();
            }, 
            function(error) {
                console.error('STOMP error:', error);
            });
        }
        
        // 참여 메시지 전송 함수
        function sendJoinMessage() {
            const joinMessage = {
                type: 'JOIN',
                roomId: roomId,
                sender: currentUser.memberId,
                nickname: currentUser.nickname,
                socialType: currentUser.socialType,
                memberImage: currentUser.memberImage
            };
            // 참여 메시지 전송
            stompClient.send("/app/chat/" + roomId + "/join", {}, JSON.stringify(joinMessage));
        }

        // 메시지 전송 함수
        function sendMessage(event) {
            event.preventDefault();
            const messageInput = document.getElementById('message');
            const messageContent = messageInput.value.trim();
            
            if (messageContent && stompClient) {
                const chatMessage = {
                    roomId: roomId,
                    sender: currentUser.memberId,
                    nickname: currentUser.nickname,
                    message: messageContent,
                    type: 'CHAT',
                    profileImage: currentUser.memberImage
                };
                
                stompClient.send("/app/chat/" + roomId + "/sendMessage", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
            messageInput.focus();
        }
        
        // 메시지 표시 함수
        function showMessage(message) {
            const messageArea = document.getElementById('messageArea');
            const messageElement = document.createElement('div');
            const isSentByMe = message.sender === currentUser.memberId;
            
            messageElement.className = `message ${isSentByMe ? 'sent' : 'received'}`;
            
            let messageHTML = '';
            
            if (message.type === 'JOIN') {
                messageElement.className = 'message system';
                messageHTML = `<div class="message-content">${message.nickname}님이 입장하셨습니다.</div>`;
            } else if (message.type === 'LEAVE') {
                messageElement.className = 'message system';
                messageHTML = `<div class="message-content">${message.nickname}님이 퇴장하셨습니다.</div>`;
            } else {
                messageHTML = `
                    ${!isSentByMe ? `
                        <div class="message-info">
                            <img src="${message.profileImage || '/images/default-profile.png'}" 
                                 alt="프로필" class="sender-avatar">
                            <span class="sender-name">${message.nickname}</span>
                        </div>
                    ` : ''}
                    <div class="message-content">${message.message}</div>
                    <div class="message-time">${formatTime(new Date())}</div>
                `;
            }
            
            messageElement.innerHTML = messageHTML;
            messageArea.appendChild(messageElement);
            messageArea.scrollTop = messageArea.scrollHeight;
        }
        
        // 시간 포맷 함수
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // 참여자 목록 업데이트 함수
        function updateParticipantsList(participants) {
            const participantsList = $('#participantsList');
            participantsList.empty();
            
            $('#participantCount').text(participants.length);
            
            participants.forEach(function(participant) {
                const isAdmin = participant.memberId === room.roomAdmin;
                const adminBadge = isAdmin ? '<span class="badge bg-primary ms-1">방장</span>' : '';
                
                participantsList.append(`
                    <div class="dropdown-item d-flex align-items-center">
                        <img src="${participant.memberImage || '/images/default-profile.png'}" 
                             class="rounded-circle me-2" 
                             style="width: 30px; height: 30px;">
                        <span>${participant.nickname}${adminBadge}</span>
                    </div>
                `);
            });
        }
        
        // 참여자 목록 토글 함수
        function toggleParticipantsList() {
            const sidebar = document.getElementById('participantsSidebar');
            sidebar.classList.toggle('show');
        }
        
        // 방 삭제 함수
        function deleteRoom() {
            if (!confirm('정말로 채팅방을 삭제하시겠습니까?\n모든 대화 내용이 삭제됩니다.')) {
                return;
            }
            
            $.ajax({
                url: `/chat/delete/${roomId}`,
                type: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.href = '/chat';
                    } else {
                        alert(response.error || '채팅방 삭제에 실패했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('채팅방 삭제에 실패했습니다.');
                }
            });
        }

        // 기존의 leaveRoom 함수 수정
        function leaveRoom() {
            if (!confirm('정말로 채팅방을 나가시겠습니까?')) {
                return;
            }
            
            $.ajax({
                url: `/api/chat/rooms/${roomId}/leave`,
                type: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.href = '/chat';
                    } else {
                        alert(response.error || '채팅방을 나가는데 실패했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert(xhr.responseJSON?.error || '채팅방을 나가는데 실패했습니다.');
                }
            });
        }
        
        // 캘린더 초기화
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                height: '100%',
                locale: 'ko',
                editable: true,
                selectable: true,
                businessHours: true,
                dayMaxEvents: true,
                nowIndicator: true,
                navLinks: false,
                fixedWeekCount: false,
                showNonCurrentDates: false,
                events: function(info, successCallback, failureCallback) {
                    $.ajax({
                        url: `/api/chat/calendar/${roomId}`,
                        type: 'GET',
                        success: function(events) {
                            const calendarEvents = events.map(event => {
                                // 날짜를 직접 Date 객체로 변환
                                const start = new Date(event.startDate);
                                const end = new Date(event.endDate);
                                return {
                                    id: event.eventId,
                                    title: event.title,
                                    start: start,
                                    end: end,
                                    description: event.description,
                                    allDay: event.all_day,
                                    display: 'block',
                                    backgroundColor: '#4A90E2',
                                    borderColor: '#4A90E2',
                                    textColor: '#ffffff',
                                    extendedProps: {
                                        description: event.description,
                                        createdBy: event.createdBy
                                    }
                                };
                            });
                            console.log('변환된 이벤트:', calendarEvents); // 디버깅용
                            successCallback(calendarEvents);
                        },
                        error: function(error) {
                            console.error('일정 로드 실패:', error);
                            failureCallback(error);
                        }
                    });
                },
                timeZone: 'local',
                displayEventEnd: true,
                slotMinTime: '00:00:00',
                slotMaxTime: '24:00:00',
                firstDay: 0,  // 일요일부터 시작
                weekNumbers: false,  // 주차 표시 제거
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false,
                    hour12: false
                },
                dayHeaderFormat: { weekday: 'short' },  // 요일 표시 형식
                titleFormat: { year: 'numeric', month: 'long' },  // 달력 제목 형식
                dayMaxEventRows: true,
                showNonCurrentDates: false,
                views: {
                    dayGrid: {
                        displayEventEnd: true,
                        eventMaxStack: 3
                    }
                },
                eventDidMount: function(info) {
                    if (info.event.allDay) {
                        info.el.style.backgroundColor = '#3788d8';
                    }
                },
                select: function(info) {
                    // 선택한 날짜를 현지 시간으로 변환
                    const startDate = moment(info.start).format('YYYY-MM-DDTHH:mm');
                    const endDate = moment(info.end).subtract(1, 'days').format('YYYY-MM-DDTHH:mm');
                    
                    document.getElementById('eventStartDate').value = startDate;
                    document.getElementById('eventEndDate').value = endDate;
                    
                    updateEndDateMin();
                    
                    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'), {
                        backdrop: 'static',
                        keyboard: false
                    });
                    eventModal.show();
                    $('#eventTitle').focus();
                },
                eventClick: function(info) {
                    const event = info.event;
                    
                    // 상세 정보 모달에 데이터 설정
                    document.getElementById('detailEventTitle').textContent = event.title;
                    document.getElementById('detailEventStart').textContent = 
                        moment(event.start).format('YYYY년 MM월 DD일 HH:mm');
                    document.getElementById('detailEventEnd').textContent = 
                        moment(event.end).format('YYYY년 MM월 DD일 HH:mm');
                    document.getElementById('detailEventDescription').textContent = 
                        event.extendedProps.description || '설명 없음';
                    document.getElementById('detailEventCreator').textContent = 
                        event.extendedProps.createdBy || '알 수 없음';
                    
                    // 삭제 버튼 표시 여부 결정 (작성자인 경우에만)
                    const deleteBtn = document.getElementById('deleteEventBtn');
                    if (event.extendedProps.createdBy === currentUser.memberId) {
                        deleteBtn.style.display = 'block';
                        deleteBtn.onclick = () => deleteEvent(event.id);
                    } else {
                        deleteBtn.style.display = 'none';
                    }
                    
                    // 모달 표시
                    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
                    modal.show();
                }
            });
            
            calendar.render();
            
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                if (e.target.getAttribute('data-bs-target') === '#calendarTab') {
                    calendar.updateSize();
                    calendar.refetchEvents();
                }
            });
            
            window.submitEvent = function() {
                const title = document.getElementById('eventTitle').value.trim();
                const description = document.getElementById('eventDescription').value.trim();
                
                const startDate = moment(document.getElementById('eventStartDate').value)
                    .format('YYYY-MM-DDTHH:mm:ss');
                const endDate = moment(document.getElementById('eventEndDate').value)
                    .format('YYYY-MM-DDTHH:mm:ss');
                
                if (!title) {
                    alert('일정 제목을 입력해주세요.');
                    return;
                }
                
                if (moment(endDate).isSameOrBefore(startDate)) {
                    alert('종료 일시는 시작 일시보다 이후여야 합니다.');
                    return;
                }
                
                const eventData = {
                    title: title,
                    description: description,
                    roomId: roomId,
                    createdBy: currentUser.memberId,
                    startDate: startDate,
                    endDate: endDate,
                    all_day: false
                };
                
                console.log('전송할 데이터:', JSON.stringify(eventData, null, 2));
                
                $.ajax({
                    url: '/api/chat/calendar',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    success: function(response) {
                        if (response.success) {
                            const eventModal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
                            eventModal.hide();
                            document.getElementById('eventForm').reset();
                            setTimeout(() => {
                                calendar.refetchEvents();
                            }, 100);
                            alert('일정이 추가되었습니다.');
                        } else {
                            alert(response.error || '일정 추가에 실패했습니다.');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        console.error('Response:', xhr.responseText);
                        console.error('전송된 데이터:', JSON.stringify(eventData));
                        alert('일정 추가에 실패했습니다.');
                    }
                });
            };
        });

        function loadParticipants() {
            $.get('/api/chat/rooms/' + roomId + '/participants', function(participants) {
                updateParticipantsList(participants);
            });
        }

        // 게시글 작성 모달 열기
        function openBoardModal() {
            const modal = new bootstrap.Modal(document.getElementById('writeBoardModal'), {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
            $('#boardTitle').focus();
        }
        
        // 게시글 작성 제출
        function submitBoard() {
            const title = $('#boardTitle').val().trim();
            const content = $('#boardContent').val().trim();
            
            if (!title || !content) {
                alert('제목과 내용을 모두 입력해주세요.');
                return;
            }
            
            const boardData = {
                roomId: roomId,
                memberId: currentUser.memberId,
                boardTitle: title,
                boardContent: content
            };
            
            $.ajax({
                url: '/api/chat/board',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(boardData),
                success: function(response) {
                    if (response.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('writeBoardModal'));
                        modal.hide();
                        loadBoardList();
                    } else {
                        alert(response.error || '게시글 작성에 실패했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('게시글 작성 중 오류가 발생했습니다.');
                }
            });
        }

        // 방장 위임 모달 표시 함수
        function showTransferAdminModal() {
            const modal = new bootstrap.Modal(document.getElementById('transferAdminModal'));
            modal.show();
        }

        // 모달 관련 전역 이벤트 핸들러
        $(document).ready(function() {
            $('.modal').on('hidden.bs.modal', function () {
                $(this).find('form').trigger('reset');
                if (!$('.modal.show').length) {
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                }
            });
        });

        // 종료 일시의 최소값을 시작 일시로 설정하는 함수
        function updateEndDateMin() {
            const startDate = document.getElementById('eventStartDate').value;
            const endDateInput = document.getElementById('eventEndDate');
            
            if (startDate) {
                endDateInput.min = startDate;
                
                if (endDateInput.value && new Date(endDateInput.value) <= new Date(startDate)) {
                    endDateInput.value = startDate;
                }
            }
        }

        // 일정 삭제 함수 추가
        function deleteEvent(eventId) {
            if (!confirm('이 일정을 삭제하시겠습니까?')) {
                return;
            }
            
            $.ajax({
                url: `/api/chat/calendar/${eventId}`,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailModal'));
                        modal.hide();
                        calendar.refetchEvents();
                        alert('일정이 삭제되었습니다.');
                    } else {
                        alert(response.error || '일정 삭제에 실패했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('일정 삭제에 실패했습니다.');
                }
            });
        }
    </script>
</th:block>
</html> 
